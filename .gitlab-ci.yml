stages:
  - test
  - coverage

# Global variables and cache
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip
    - venv/

# ------------- Base Templates -------------

.test-template: &test-template
  stage: test
  before_script:
    - python -m pip install --upgrade pip setuptools wheel
    - python -m pip install -e .[test]
  script:
    - python -c "import gwsim; print('gwsim version:', gwsim.__version__)"
    - gwsim --help
    - export COVERAGE_FILE=.coverage.$CI_JOB_NAME
    - pytest --cov-config=.coveragerc --junitxml=test-results.xml --cov=gwsim --cov-report=xml --cov-report=term-summary
  artifacts:
    when: always
    paths:
      - .coverage.*
      - test-results.xml
      - coverage.xml
    reports:
      junit: test-results.xml
  only:
    - merge_requests
    - main

# ------------- Test Jobs -------------

test-python-3.10:
  <<: *test-template
  image: python:3.10

test-python-3.11:
  <<: *test-template
  image: python:3.11

test-python-3.12:
  <<: *test-template
  image: python:3.12

# ------------- Coverage Summary -------------

coverage-report:
  stage: coverage
  image: python:3.12
  before_script:
    - python -m pip install --upgrade pip
    - python -m pip install coverage[toml]
  script:
    - echo "Combining coverage reports from all Python versions"
    - coverage combine .coverage.*
    - coverage report --show-missing
    - coverage html
    - coverage xml
    - echo "Coverage report generated successfully"
  artifacts:
    when: always
    paths:
      - htmlcov/
      - coverage.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  needs:
    - test-python-3.10
    - test-python-3.11
    - test-python-3.12
  only:
    - merge_requests
    - main
